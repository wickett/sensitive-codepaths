name: Check for changes in specified codepaths

on:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  check_changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Install yq
        run: |
          sudo snap install yq

      - name: Check for changes in specified codepaths
        id: check_changes
        run: |
          # Read codepaths from sensitive-codepaths.yml
          codepaths=$(yq e '.codepaths' sensitive-codepaths.yml)
          changes_detected=false

          for codepath in $codepaths; do
            git diff --quiet --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- "$codepath"
            if [ $? -eq 0 ]; then
              changes_detected=true
              break
            fi
          done

          pr_comment=""

          if [ "$changes_detected" == "true" ]; then
            pr_comment+="ðŸš¨ **$impacted_codepaths_count sensitive codepaths impacted!** ðŸš¨\n\nChanges detected in specified codepaths. Please review carefully! ðŸ’¥"
          else
            pr_comment+="ðŸŽ‰ **No sensitive codepaths impacted!** ðŸŽ‰\n\nNo changes detected in specified codepaths. Good to go! ðŸš€"
          fi

          echo "::set-output name=pr_comment::$pr_comment"

      - name: Print result
        run: |
          if [ ${{ steps.check_changes.outputs.changes_detected }} == "true" ]; then
            echo "Changes detected in specified codepaths"
          else
            echo "No changes detected in specified codepaths"
          fi

      - name: Post result to pull request
        run: |
          pr_comment=${{ steps.check_changes.outputs.pr_comment }}
          echo "$pr_comment" | gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body-file=-
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}