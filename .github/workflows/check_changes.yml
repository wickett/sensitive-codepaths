name: Check Sensitive Codepaths

on:
  pull_request:
  push:

jobs:
  check_changes:
    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.x

    - name: Install jq
      run: sudo apt-get install jq

    - name: Install yq
      run: pip install yq

    - name: Check sensitive codepaths (pull_request)
      if: ${{ github.event_name == 'pull_request' }}
      run: |
        # Read codepaths from sensitive-codepaths.yml
        codepaths=$(yq r sensitive-codepaths.yml codepaths.*)
        changes_detected=false
        impacted_codepaths_count=0

        for codepath in $codepaths; do
          git diff --quiet --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- "$codepath"
          if [ $? -eq 0 ]; then
            changes_detected=true
            impacted_codepaths_count=$((impacted_codepaths_count + 1))
          fi
        done

        echo "changes_detected=$changes_detected" >> $GITHUB_ENV
        echo "impacted_codepaths_count=$impacted_codepaths_count" >> $GITHUB_ENV

    - name: Check sensitive codepaths (push)
      if: ${{ github.event_name == 'push' }}
      run: |
        # Read codepaths from sensitive-codepaths.yml
        codepaths=$(yq r sensitive-codepaths.yml codepaths.*)
        changes_detected=false
        impacted_codepaths_count=0

        for codepath in $codepaths; do
          git diff --quiet --name-only "$GITHUB_SHA"~1 "$GITHUB_SHA" -- "$codepath"
          if [ $? -eq 0 ]; then
            changes_detected=true
            impacted_codepaths_count=$((impacted_codepaths_count + 1))
          fi
        done

        echo "changes_detected=$changes_detected" >> $GITHUB_ENV
        echo "impacted_codepaths_count=$impacted_codepaths_count" >> $GITHUB_ENV

    - name: Post result
      run: |
        pr_comment=""
        if [ "$changes_detected" == "true" ]; then
          pr_comment+="ðŸš¨ **$impacted_codepaths_count sensitive codepaths impacted!** ðŸš¨\n\nChanges detected in specified codepaths. Please review carefully! ðŸ’¥"
        else
          pr_comment+="ðŸŽ‰ **No sensitive codepaths impacted!** ðŸŽ‰\n\nNo changes detected in specified codepaths. Good to go! ðŸš€"
        fi
      
        pr_comment_encoded=$(echo -n "$pr_comment" | jq -sRr @json)
      
        if [ "$GITHUB_EVENT_NAME" == "pull_request" ]; then
          echo "$pr_comment" | gh pr comment --repo "$GITHUB_REPOSITORY" --body-file=-
        elif [ "$GITHUB_EVENT_NAME" == "push" ]; then
          commit_sha="$GITHUB_SHA"
          gh api repos/"$GITHUB_REPOSITORY"/commits/$commit_sha/comments -f body="$pr_comment_encoded"
        fi
      env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_PAT }}
