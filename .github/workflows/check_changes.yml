name: Check for changes in specified codepaths

on:
  push:
    branches:
      - '**'
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  check_changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Install yq
        run: |
          sudo snap install yq

      - name: Check for changes in specified codepaths
        id: check_changes
        run: | 
          # Read codepaths from sensitive-codepaths.yml
          codepaths=$(yq e '.codepaths' sensitive-codepaths.yml)
          changes_detected=false

          for codepath in $codepaths; do
            git diff --quiet --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- "$codepath"
            if [ $? -eq 0 ]; then
              changes_detected=true
              break
            fi
          done

          pr_comment=""

          if [ "$changes_detected" == "true" ]; then
            pr_comment+="ðŸš¨ **$impacted_codepaths_count sensitive codepaths impacted!** ðŸš¨\n\nChanges detected in specified codepaths. Please review carefully! ðŸ’¥"
          else
            pr_comment+="ðŸŽ‰ **No sensitive codepaths impacted!** ðŸŽ‰\n\nNo changes detected in specified codepaths. Good to go! ðŸš€"
          fi

          echo "::set-output name=pr_comment::$pr_comment"

          # Set the commit_sha output variable
          echo "::set-output name=commit_sha::${{ github.sha }}"

      - name: Post result
        run: |
          pr_comment="${{ steps.check_changes.outputs.pr_comment }}"
          commit_sha="${{ steps.check_changes.outputs.commit_sha }}"
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "$pr_comment" | gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body-file=-
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "$pr_comment" | gh api repos/${{ github.repository }}/commits/$commit_sha/comments --input=-
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}